{
  "filter_id": 1,
  "group_id": 41,
  "catalog": "ZTF_alerts",
  "permissions": [1, 2, 3],
  "active": true,
  "autosave": false,
  "auto_followup": {},
  "update_annotations": false,
  "active_fid": "first",
  "fv": [
    {
      "fid": "first",
      "created_at": "2021-01-01T00:00:00",
      "pipeline": [
        {
          "$match": {
            "candidate.rb": {
              "$gte": 0.3
            },
            "candidate.drb": {
              "$gt": 0.5
            },
            "candidate.fwhm": {
              "$gt": 0.5,
              "$lt": 8
            },
            "candidate.ndethist": {
              "$lte": 200
            },
            "candidate.nbad": {
              "$lt": 5
            },
            "candidate.isdiffpos": true,
            "$and": [
              {
                "$or": [
                  {
                    "candidate.ssdistnr": {
                      "$lt": 0
                    }
                  },
                  {
                    "candidate.ssdistnr": {
                      "$gte": 12
                    }
                  },
                  {
                    "candidate.ssmagnr": {
                      "$lte": 0
                    }
                  },
                  {
                    "candidate.ssmagnr": {
                      "$eq": null
                    }
                  },
                  {
                    "$expr": {
                      "$gte": [
                        {
                          "$abs": {
                            "$subtract": [
                              "$candidate.magpsf",
                              "$candidate.ssmagnr"
                            ]
                          }
                        },
                        2
                      ]
                    }
                  }
                ]
              },
              {
                "$expr": {
                  "$lt": [
                    {
                      "$abs": {
                        "$subtract": ["$candidate.magpsf", "$candidate.magap"]
                      }
                    },
                    0.75
                  ]
                }
              }
            ]
          }
        },
        {
          "$match": {
            "cross_matches.NED.0": {
              "$exists": true
            }
          }
        },
        {
          "$project": {
            "objectId": 1,
            "candidate": {
              "jd": 1,
              "magpsf": 1,
              "sigmapsf": 1,
              "jdstarthist": 1,
              "ndethist": 1,
              "drb": 1,
              "rb": 1
            },
            "ned_150": {
              "$filter": {
                "input": "$cross_matches.NED",
                "as": "host",
                "cond": {
                  "$and": [
                    {
                      "$isNumber": "$$host.z"
                    },
                    {
                      "$lte": ["$$host.z", 0.033028]
                    },
                    {
                      "$in": ["$$host.objtype", ["G", "GPair", "GTrpl", "PofG"]]
                    }
                  ]
                }
              }
            },
            "ned_150_any_nuclear": {
              "$anyElementTrue": {
                "$map": {
                  "input": "$cross_matches.NED",
                  "as": "host",
                  "in": {
                    "$and": [
                      {
                        "$isNumber": "$$host.z"
                      },
                      {
                        "$lte": ["$$host.z", 0.033028]
                      },
                      {
                        "$in": [
                          "$$host.objtype",
                          ["G", "GPair", "GTrpl", "PofG"]
                        ]
                      },
                      {
                        "$lte": ["$$host.coordinates.distance_arcsec", 2]
                      }
                    ]
                  }
                }
              }
            },
            "ned_150_all_nearby": {
              "$allElementsTrue": {
                "$map": {
                  "input": "$cross_matches.NED",
                  "as": "host",
                  "in": {
                    "$and": [
                      {
                        "$isNumber": "$$host.z"
                      },
                      {
                        "$in": [
                          "$$host.objtype",
                          ["G", "GPair", "GTrpl", "PofG"]
                        ]
                      },
                      {
                        "$lte": ["$$host.z", 0]
                      }
                    ]
                  }
                }
              }
            },
            "ned_distant_hosts": {
              "$filter": {
                "input": "$cross_matches.NED",
                "as": "host",
                "cond": {
                  "$and": [
                    {
                      "$isNumber": "$$host.z"
                    },
                    {
                      "$in": ["$$host.objtype", ["G", "GPair", "GTrpl", "PofG"]]
                    },
                    {
                      "$gt": ["$$host.z", 0.033028]
                    }
                  ]
                }
              }
            },
            "stationary": {
              "$or": [
                {
                  "$anyElementTrue": {
                    "$map": {
                      "input": "$prv_candidates",
                      "as": "cand",
                      "in": {
                        "$and": [
                          {
                            "$gt": [
                              {
                                "$abs": {
                                  "$subtract": ["$candidate.jd", "$$cand.jd"]
                                }
                              },
                              0.007
                            ]
                          },
                          {
                            "$lte": [
                              {
                                "$abs": {
                                  "$subtract": ["$candidate.jd", "$$cand.jd"]
                                }
                              },
                              3.0
                            ]
                          },
                          {
                            "$lt": ["$$cand.magpsf", 99]
                          },
                          {
                            "$eq": ["$$cand.isdiffpos", true]
                          },
                          {
                            "$or": [
                              {
                                "$lt": ["$$cand.ssdistnr", 0]
                              },
                              {
                                "$gt": ["$$cand.ssdistnr", 2]
                              }
                            ]
                          }
                        ]
                      }
                    }
                  }
                },
                {
                  "$anyElementTrue": {
                    "$map": {
                      "input": {
                        "$ifNull": ["$fp_hists", []]
                      },
                      "as": "cand",
                      "in": {
                        "$and": [
                          {
                            "$gt": [
                              {
                                "$abs": {
                                  "$subtract": ["$candidate.jd", "$$cand.jd"]
                                }
                              },
                              0.007
                            ]
                          },
                          {
                            "$lte": [
                              {
                                "$abs": {
                                  "$subtract": ["$candidate.jd", "$$cand.jd"]
                                }
                              },
                              3.0
                            ]
                          },
                          {
                            "$gte": ["$$cand.snr", 4]
                          },
                          {
                            "$eq": ["$$cand.procstatus", "0"]
                          }
                        ]
                      }
                    }
                  }
                }
              ]
            },
            "star": {
              "$and": [
                {
                  "$gt": ["$candidate.sgscore1", 0.76]
                },
                {
                  "$lt": ["$candidate.distpsnr1", 2]
                }
              ]
            },
            "near_brightstar": {
              "$or": [
                {
                  "$and": [
                    {
                      "$lt": ["$candidate.distpsnr1", 20]
                    },
                    {
                      "$lt": ["$candidate.srmag", 15]
                    },
                    {
                      "$gt": ["$candidate.srmag", 0]
                    },
                    {
                      "$gt": ["$candidate.sgscore1", 0.49]
                    }
                  ]
                },
                {
                  "$and": [
                    {
                      "$lt": ["$candidate.distpsnr2", 20]
                    },
                    {
                      "$lt": ["$candidate.srmag2", 15]
                    },
                    {
                      "$gt": ["$candidate.srmag2", 0]
                    },
                    {
                      "$gt": ["$candidate.sgscore2", 0.49]
                    }
                  ]
                },
                {
                  "$and": [
                    {
                      "$lt": ["$candidate.distpsnr3", 20]
                    },
                    {
                      "$lt": ["$candidate.srmag3", 15]
                    },
                    {
                      "$gt": ["$candidate.srmag3", 0]
                    },
                    {
                      "$gt": ["$candidate.sgscore3", 0.49]
                    }
                  ]
                },
                {
                  "$and": [
                    {
                      "$eq": ["$candidate.sgscore1", 0.5]
                    },
                    {
                      "$lt": ["$candidate.distpsnr1", 0.5]
                    },
                    {
                      "$or": [
                        {
                          "$lt": [
                            {
                              "$abs": "$candidate.sgmag1"
                            },
                            17
                          ]
                        },
                        {
                          "$lt": [
                            {
                              "$abs": "$candidate.srmag1"
                            },
                            17
                          ]
                        },
                        {
                          "$lt": [
                            {
                              "$abs": "$candidate.simag1"
                            },
                            17
                          ]
                        }
                      ]
                    }
                  ]
                }
              ]
            },
            "mag_cut": {
              "$or": [
                {
                  "$lt": [
                    {
                      "$subtract": ["$candidate.magpsf", "$candidate.sigmapsf"]
                    },
                    20
                  ]
                },
                {
                  "$anyElementTrue": {
                    "$map": {
                      "input": "$prv_candidates",
                      "as": "cand",
                      "in": {
                        "$and": [
                          {
                            "$eq": ["$$cand.isdiffpos", true]
                          },
                          {
                            "$or": [
                              {
                                "$lt": ["$$cand.ssdistnr", -0.5]
                              },
                              {
                                "$gt": ["$$cand.ssdistnr", 2]
                              }
                            ]
                          },
                          {
                            "$lt": [
                              {
                                "$subtract": [
                                  "$$cand.magpsf",
                                  "$$cand.sigmapsf"
                                ]
                              },
                              20
                            ]
                          }
                        ]
                      }
                    }
                  }
                },
                {
                  "$anyElementTrue": {
                    "$map": {
                      "input": {
                        "$ifNull": ["$fp_hists", []]
                      },
                      "as": "cand",
                      "in": {
                        "$and": [
                          {
                            "$gte": ["$$cand.snr", 4]
                          },
                          {
                            "$eq": ["$$cand.procstatus", "0"]
                          },
                          {
                            "$lt": [
                              {
                                "$subtract": ["$$cand.mag", "$$cand.magerr"]
                              },
                              20
                            ]
                          }
                        ]
                      }
                    }
                  }
                }
              ]
            }
          }
        },
        {
          "$match": {
            "ned_150.0": {
              "$exists": true
            },
            "star": false,
            "near_brightstar": false,
            "stationary": true,
            "mag_cut": true,
            "$and": [
              {
                "$or": [
                  {
                    "ned_150_all_nearby": false
                  },
                  {
                    "candidate.magpsf": {
                      "$lte": 18
                    }
                  }
                ]
              },
              {
                "$or": [
                  {
                    "ned_distant_hosts": {
                      "$eq": []
                    }
                  },
                  {
                    "$expr": {
                      "$lt": [
                        {
                          "$min": "$ned_150.coordinates.distance_arcsec"
                        },
                        {
                          "$min": "$ned_distant_hosts.coordinates.distance_arcsec"
                        }
                      ]
                    }
                  }
                ]
              }
            ]
          }
        },
        {
          "$project": {
            "objectId": 1,
            "annotations": {
              "mag": {
                "$round": ["$candidate.magpsf", 4]
              },
              "jd": {
                "$round": ["$candidate.jd", 4]
              },
              "age": {
                "$round": [
                  {
                    "$subtract": ["$candidate.jd", "$candidate.jdstarthist"]
                  },
                  4
                ]
              },
              "drb": {
                "$round": ["$candidate.drb", 2]
              },
              "nb_detections": "$candidate.ndethist",
              "ned_150_closest": {
                "$round": [
                  {
                    "$min": "$ned_150.coordinates.distance_arcsec"
                  },
                  2
                ]
              },
              "ned_150_hosts": {
                "$map": {
                  "input": "$ned_150",
                  "as": "match",
                  "in": {
                    "name": "$$match.objname",
                    "z": {
                      "$round": ["$$match.z", 6]
                    },
                    "z_err": {
                      "$round": ["$$match.z_unc", 6]
                    },
                    "arcsec": {
                      "$round": ["$$match.coordinates.distance_arcsec", 2]
                    },
                    "kpc": {
                      "$round": ["$$match.coordinates.distance_kpc", 2]
                    },
                    "z_tech": "$$match.z_tech"
                  }
                }
              }
            }
          }
        }
      ]
    }
  ],
  "created_at": "2021-01-01T00:00:00",
  "last_modified": "2021-01-01T00:00:00"
}
