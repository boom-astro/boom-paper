name: boom-paper
title: A real-time, multi-survey, optical alert system broker
  operating at scale
dependencies:
  - git-lfs
environments:
  tex:
    kind: docker
    image: texlive/texlive:latest-full
    description: TeXlive via Docker.
  analyze-logs:
    path: config/envs/analyze-logs.txt
    kind: uv-venv
    prefix: .venv
    python: "3.13.5"
  simulate-queues:
    path: config/envs/simulate-queues.txt
    kind: uv-venv
    prefix: .venv2
    python: "3.13.5"
  run:
    path: config/envs/run.txt
    kind: uv-venv
    prefix: .venv3
    python: "3.13.5"
pipeline:
  stages:
    # TODO: Add manual step stage for exporting workflow diagram
    # TODO: Cache producer and NED loading
    benchmark-boom:
      kind: python-script
      script_path: scripts/benchmark-boom.py
      args:
        - --n-alert-workers={n_alert_workers}
        - --n-ml-workers={n_ml_workers}
        - --n-filter-workers={n_filter_workers}
      environment: run
      inputs:
        - boom/src
        - boom/Cargo.lock
        - boom/Cargo.toml
        - scripts/benchmark-boom.sh
        - config/boom/config-template.yaml
        - config/boom/compose.yaml
        - Dockerfile-boom
        - scripts/mongo-init.sh
        - data/kowalski.NED.json.gz
        - config/boom/cats150.boom.json
      iterate_over:
        - arg_name: n_alert_workers
          values: [1, 3, 6]
        - arg_name: n_ml_workers
          values: [3, 6, 9]
        - arg_name: n_filter_workers
          values: [1, 3]
        # - arg_name: repetition
        #   values:
        #     - range:
        #         start: 1
        #         stop: 50
      outputs:
        - logs/boom-na={n_alert_workers}-nml={n_ml_workers}-nf={n_filter_workers}
    benchmark-kowalski:
      kind: python-script
      script_path: scripts/benchmark-kowalski.py
      args:
        - --n-workers={n_workers}
      environment: run
      inputs:
        - config/kowalski/config-template.yaml
        - config/kowalski/compose.yaml
        - config/kowalski/supervisord.conf
        - kowalski/ingester.Dockerfile
        - kowalski/kowalski
        - kowalski/Makefile
        - kowalski/requirements
        - scripts/mongo-init.sh
        - scripts/benchmark-kowalski.sh
        - data/kowalski.NED.json.gz
        - config/kowalski/cats150.kowalski.json
      iterate_over:
        - arg_name: n_workers
          values: [3, 6, 7, 9, 12, 15]
      outputs:
        - logs/kowalski-n={n_workers}
    analyze-logs:
      kind: jupyter-notebook
      notebook_path: notebooks/analyze-logs.ipynb
      environment: analyze-logs
      html_storage: git
      executed_ipynb_storage: git
      cleaned_ipynb_storage: git
      inputs:
        - from_stage_outputs: benchmark-boom
        - from_stage_outputs: benchmark-kowalski
      outputs:
        - path: paper/results.tex
          storage: git
        - path: results
          storage: git
    build-paper:
      kind: latex
      environment: tex
      target_path: paper/main.tex
      force: true
      inputs:
        - paper/references.bib
        - paper/figures/workflow.pdf
        - paper/aasjournal.bst
        - paper/aastex631.cls
        - paper/results.tex
# These are pulled out into the run logs
metrics:
  boom_n_ml_workers:
    stage: benchmark-boom
    description: Number of BOOM machine learning workers.
    read_from:
      path: config/boom/config.yaml
      key: workers.ZTF.ml.n_workers
  boom_run_time_s:
    description: Total run time of the BOOM benchmark in seconds.
    stage: benchmark-boom
    read_from:
      path: results/results.json
      key: boom_run_time_s
  kowalski_run_time_s:
    description: Total run time of the Kowalski benchmark in seconds.
    stage: benchmark-kowalski
    read_from:
      path: results/results.json
      key: kowalski_run_time_s
datasets:
  - path: data/kowalski.NED.json.gz
    title: NED archival catalog
    description: Alerts from the NED archival catalog exported from
      Kowalski.
figures:
  - path: paper/figures/workflow.pdf
    title: BOOM workflow
publications:
  - path: paper/main.pdf
    title: A real-time, multi-survey, optical alert system broker
      operating at scale
    description:
    kind: journal-article
    stage: build-paper
    overleaf:
      project_id: 67eb247c542af4e06002e7e8
      wdir: paper
      sync_paths:
        - main.tex
        - references.bib
        - aasjournal.bst
        - aastex631.cls
      # Keep these out of Git in this project so we don't bloat the repo, but
      # can still version them with DVC
      dvc_sync_paths:
        - figures/workflow.key
        - figures/workflow.pdf
      push_paths:
        - results.tex
      last_sync_commit: b3a466bdb76a7c6dc80dbeeaa00d201ef979b51a
notebooks:
  - path: notebooks/analyze-logs.ipynb
    title: Analyzing the logs
    description: Analyze the logs from the BOOM and Kowalski
      benchmarks.
references:
  - path: paper/references.bib
showcase:
  - publication: paper/main.pdf
